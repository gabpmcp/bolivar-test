services:
  localstack:
    image: localstack/localstack:3
    ports:
      - "4566:4566"
    environment:
      AWS_DEFAULT_REGION: us-east-1
      SERVICES: s3,sqs,dynamodb
      S3_BUCKET_EVENTS: reservations-events
      SQS_QUEUE_NAME: reservations-events
      USERS_PROJECTION_TABLE: users_projection
      RESOURCES_PROJECTION_TABLE: resources_projection
      RESERVATIONS_PROJECTION_TABLE: reservations_projection
      IDEMPOTENCY_TABLE: idempotency_table
      PROJECTION_LAG_TABLE: projection_lag
    volumes:
      - localstack_data:/var/lib/localstack

  infra-init:
    image: amazon/aws-cli:2
    depends_on:
      - localstack
    environment:
      AWS_DEFAULT_REGION: us-east-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      S3_BUCKET_EVENTS: reservations-events
      SQS_QUEUE_NAME: reservations-events
      USERS_PROJECTION_TABLE: users_projection
      RESOURCES_PROJECTION_TABLE: resources_projection
      RESERVATIONS_PROJECTION_TABLE: reservations_projection
      IDEMPOTENCY_TABLE: idempotency_table
      PROJECTION_LAG_TABLE: projection_lag
    entrypoint: ["/bin/sh", "-c"]
    command: >
      set -e;
      until aws --endpoint-url=http://localstack:4566 s3 ls >/dev/null 2>&1; do sleep 2; done;
      aws --endpoint-url=http://localstack:4566 s3api head-bucket --bucket "$S3_BUCKET_EVENTS" >/dev/null 2>&1
      || aws --endpoint-url=http://localstack:4566 s3 mb "s3://$S3_BUCKET_EVENTS";
      aws --endpoint-url=http://localstack:4566 sqs create-queue --queue-name "$SQS_QUEUE_NAME" >/dev/null;
      aws --endpoint-url=http://localstack:4566 dynamodb describe-table --table-name "$USERS_PROJECTION_TABLE" >/dev/null 2>&1
      || aws --endpoint-url=http://localstack:4566 dynamodb create-table --table-name "$USERS_PROJECTION_TABLE" --attribute-definitions AttributeName=userId,AttributeType=S --key-schema AttributeName=userId,KeyType=HASH --billing-mode PAY_PER_REQUEST >/dev/null;
      aws --endpoint-url=http://localstack:4566 dynamodb describe-table --table-name "$RESOURCES_PROJECTION_TABLE" >/dev/null 2>&1
      || aws --endpoint-url=http://localstack:4566 dynamodb create-table --table-name "$RESOURCES_PROJECTION_TABLE" --attribute-definitions AttributeName=resourceId,AttributeType=S --key-schema AttributeName=resourceId,KeyType=HASH --billing-mode PAY_PER_REQUEST >/dev/null;
      aws --endpoint-url=http://localstack:4566 dynamodb describe-table --table-name "$RESERVATIONS_PROJECTION_TABLE" >/dev/null 2>&1
      || aws --endpoint-url=http://localstack:4566 dynamodb create-table --table-name "$RESERVATIONS_PROJECTION_TABLE" --attribute-definitions AttributeName=reservationId,AttributeType=S --key-schema AttributeName=reservationId,KeyType=HASH --billing-mode PAY_PER_REQUEST >/dev/null;
      aws --endpoint-url=http://localstack:4566 dynamodb describe-table --table-name "$IDEMPOTENCY_TABLE" >/dev/null 2>&1
      || aws --endpoint-url=http://localstack:4566 dynamodb create-table --table-name "$IDEMPOTENCY_TABLE" --attribute-definitions AttributeName=idempotencyKey,AttributeType=S --key-schema AttributeName=idempotencyKey,KeyType=HASH --billing-mode PAY_PER_REQUEST >/dev/null;
      aws --endpoint-url=http://localstack:4566 dynamodb describe-table --table-name "$PROJECTION_LAG_TABLE" >/dev/null 2>&1
      || aws --endpoint-url=http://localstack:4566 dynamodb create-table --table-name "$PROJECTION_LAG_TABLE" --attribute-definitions AttributeName=projection,AttributeType=S --key-schema AttributeName=projection,KeyType=HASH --billing-mode PAY_PER_REQUEST >/dev/null;

  api:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      infra-init:
        condition: service_completed_successfully
    ports:
      - "3000:3000"
    environment:
      PORT: 3000
      JWT_SECRET: local-dev-secret
      ADMIN_BOOTSTRAP_KEY: bootstrap-local-key
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      S3_ENDPOINT: http://localstack:4566
      S3_BUCKET_EVENTS: reservations-events
      DYNAMO_ENDPOINT: http://localstack:4566
      SQS_ENDPOINT: http://localstack:4566
      SQS_QUEUE_URL: http://localstack:4566/000000000000/reservations-events
      USERS_PROJECTION_TABLE: users_projection
      RESOURCES_PROJECTION_TABLE: resources_projection
      RESERVATIONS_PROJECTION_TABLE: reservations_projection
      IDEMPOTENCY_TABLE: idempotency_table
      PROJECTION_LAG_TABLE: projection_lag
      SNAPSHOT_EVERY_DEFAULT: 500
      SNAPSHOT_BY_STREAM_TYPE: '{"resource":500,"user":0}'

  worker:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      infra-init:
        condition: service_completed_successfully
    command: ["node", "apps/api/dist/worker.js"]
    environment:
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      S3_ENDPOINT: http://localstack:4566
      S3_BUCKET_EVENTS: reservations-events
      DYNAMO_ENDPOINT: http://localstack:4566
      SQS_ENDPOINT: http://localstack:4566
      SQS_QUEUE_URL: http://localstack:4566/000000000000/reservations-events
      USERS_PROJECTION_TABLE: users_projection
      RESOURCES_PROJECTION_TABLE: resources_projection
      RESERVATIONS_PROJECTION_TABLE: reservations_projection
      IDEMPOTENCY_TABLE: idempotency_table
      PROJECTION_LAG_TABLE: projection_lag
      SNAPSHOT_EVERY_DEFAULT: 500
      SNAPSHOT_BY_STREAM_TYPE: '{"resource":500,"user":0}'

volumes:
  localstack_data:
